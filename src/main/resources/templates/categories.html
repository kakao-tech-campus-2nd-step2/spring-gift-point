<!DOCTYPE html>
<div th:replace="layout :: header"></div>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between mb-3">
        <h2>Manage Categories</h2>
        <div>
            <button class="btn btn-danger" id="deleteSelected">Delete</button>
            <button class="btn btn-success" id="addCategory">Add New Category</button>
        </div>
    </div>
    <!-- Search Box -->
    <!--<div class="row mb-3">
        <div class="col-md-8">
            <input type="text" class="form-control" id="searchCategoryId" placeholder="Category ID ÏûÖÎ†•">
        </div>
        <div class="col-md-4">
            <button class="btn btn-primary btn-block" id="searchCategory">Search</button>
        </div>
    </div>-->
    <!-- Categories Table -->
    <table class="table table-striped">
        <!-- table header -->
        <thead class="thead-dark">
        <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>Name</th>
            <th>Color</th>
            <th>Image URL</th>
            <th>Description</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="categoryTableBody">
        </tbody>
    </table>

    <!-- Pagination -->
    <nav aria-label="Page navigation example">
        <ul class="pagination" id="pagination">
        </ul>
    </nav>
</div>

<!-- Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1" role="dialog" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalLabel">Add New Category</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- form ÏùÑ ÌÜµÌï¥ POST, PUT api ÏöîÏ≤≠ÏùÑ Î≥¥ÎÇ∏Îã§ -->
                <form id="categoryForm">
                    <input type="hidden" id="categoryId" name="id">
                    <div class="form-group">
                        <label for="categoryName">Name</label>
                        <input type="text" class="form-control" id="categoryName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="categoryColor">Color</label>
                        <input type="text" class="form-control" id="categoryColor" name="color" required>
                    </div>
                    <div class="form-group">
                        <label for="categoryImageUrl">Image URL</label>
                        <input type="text" class="form-control" id="categoryImageUrl" name="imageUrl" required>
                    </div>
                    <div class="form-group">
                        <label for="categoryDescription">Description</label>
                        <textarea class="form-control" id="categoryDescription" name="description" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveCategory">Save changes</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        const apiBaseUrl = '/api/categories';
        let currentPage = 0;

        function loadCategories(page) {
            $.get(apiBaseUrl + '?page=' + page, function (response) {
                $('#categoryTableBody').empty();
                response.data.forEach(category => {
                    $('#categoryTableBody').append(`
                        <tr data-id="${category.id}">
                            <td><input type="checkbox" class="categoryCheckbox"></td>
                            <td>${category.name}</td>
                            <td>${category.color}</td>
                            <td>${category.imageUrl}</td>
                            <td>${category.description}</td>
                            <td>
                                <button class="btn btn-warning btn-sm editCategory">‚úèÔ∏è</button>
                                <button class="btn btn-danger btn-sm deleteCategory">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `);
                });
            });
        }

        $('#addCategory').click(function () {
            $('#categoryModalLabel').text('Add New Category');
            $('#categoryForm')[0].reset();
            $('#categoryId').val('');
            $('#categoryModal').modal('show');
        });

        $('#saveCategory').click(function () {
            const categoryData = {
                name: $('#categoryName').val(),
                color: $('#categoryColor').val(),
                imageUrl: $('#categoryImageUrl').val(),
                description: $('#categoryDescription').val()
            };
            const categoryId = $('#categoryId').val();

            const ajaxOptions = {
                url: apiBaseUrl,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(categoryData),
                success: function () {
                    $('#categoryModal').modal('hide');
                    loadCategories(currentPage);
                },
                error: function (xhr) {
                    if (xhr.status >= 400 && xhr.status < 500) {
                        alert(xhr.responseJSON.message);
                    }
                }
            };

            if (categoryId) {
                ajaxOptions.url = apiBaseUrl + '/' + categoryId;
                ajaxOptions.type = 'PUT';
            }

            $.ajax(ajaxOptions);
        });

        $(document).on('click', '.editCategory', function () {
            const categoryId = $(this).closest('tr').data('id');
            $.get(apiBaseUrl + '/' + categoryId, function (response) {
                $('#categoryModalLabel').text('Edit Category');
                $('#categoryId').val(response.data.id);
                $('#categoryName').val(response.data.name);
                $('#categoryColor').val(response.data.color);
                $('#categoryImageUrl').val(response.data.imageUrl);
                $('#categoryDescription').val(response.data.description);
                $('#categoryModal').modal('show');
            });
        });

        $(document).on('click', '.deleteCategory', function () {
            const categoryId = $(this).closest('tr').data('id');
            $.ajax({
                url: apiBaseUrl + '/' + categoryId,
                type: 'DELETE',
                success: function () {
                    loadCategories(currentPage);
                }
            });
        });

        $('#deleteSelected').click(function () {
            $('.categoryCheckbox:checked').each(function () {
                const categoryId = $(this).closest('tr').data('id');
                $.ajax({
                    url: apiBaseUrl + '/' + categoryId,
                    type: 'DELETE',
                    success: function () {
                        loadCategories(currentPage);
                    }
                });
            });
        });

        $('#selectAll').click(function () {
            $('.categoryCheckbox').prop('checked', this.checked);
        });

        $('#searchCategory').click(function () {
            const categoryId = $('#searchCategoryId').val();
            if (categoryId) {
                $.ajax({
                    url: apiBaseUrl + '/' + categoryId,
                    type: 'GET',
                    success: function (response) {
                        const $categoryTableBody = $('#categoryTableBody');
                        $categoryTableBody.empty();
                        const category = response.data;
                        $categoryTableBody.append(`
                            <tr data-id="${category.id}">
                                <td><input type="checkbox" class="categoryCheckbox"></td>
                                <td>${category.name}</td>
                                <td>${category.color}</td>
                                <td>${category.imageUrl}</td>
                                <td>${category.description}</td>
                                <td>
                                    <button class="btn btn-warning btn-sm editCategory">‚úèÔ∏è</button>
                                    <button class="btn btn-danger btn-sm deleteCategory">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `);
                    },
                    error: function (xhr) {
                        if (xhr.responseJSON && xhr.responseJSON.code === 'EC001') {
                            alert(xhr.responseJSON.message);
                            return;
                        }
                        alert('An error occurred while fetching the category.');
                    }
                });
            } else {
                loadCategories(currentPage);
            }
        });

        loadCategories(currentPage);
    });
</script>
</body>
</html>
